@using Omniscient.Shared
@using Omniscient.Shared.Dtos
@using Omniscient.Shared.Entities
@using Omniscient.Web.Clients

@page "/"
@rendermode InteractiveServer

@inject IndexerClient IndexerClient

<PageTitle>Omniscient</PageTitle>

<div class="container">
    <h1>Search</h1>
    <SearchBar OnSearch="HandleSearch" />
    <DisplayList Emails="_emails" OnPageChange="ChangePageIndex" OnEmailSelected="ViewEmail" SelectedEmail="_selectedEmail"/>
</div>


@code {
    private PaginatedList<EmailDto>? _emails;
    private Email? _selectedEmail;
    private string _query = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Search(_query);
    }
    
    private async Task HandleSearch(string query)
    {
        await Search(query);
    }
    
    private async Task Search(string query, int pageIndex = 1, int pageSize = 10)
    {
        _query = query;
        _emails = await IndexerClient.SearchEmailsAsync(_query, pageIndex, pageSize);
    }

    private async Task ChangePageIndex(int pageIndex)
    {
        await Search(_query, pageIndex);
    }

    private async Task ViewEmail(Guid emailId)
    {
        _selectedEmail = await IndexerClient.GetEmailAsync(emailId);
    }
}